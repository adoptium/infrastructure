---
# Updates $HOME/ansible.log with the date and time of latest ansible playbook run

- name: Set Log path
  set_fact:
    log_path: /var/log

- name: Set variables (MacOS)
  set_fact:
    user_group: "staff"
  when:
    - ansible_distribution == "MacOSX"

- name: Set variables (Not MacOS)
  set_fact:
    user_group: "root"
  when:
    - ansible_distribution != "MacOSX"

- name: List directory /infrastructure
  shell: ls -la /infrastructure
  register: ls_inf
  delegate_to: localhost

- name: List directory /
  shell: ls -la /
  register: ls_root_dir
  delegate_to: localhost

- name: List directory /infrastructure/ansible
  shell: ls -la /infrastructure/ansible
  register: ls_root_dir
  delegate_to: localhost

- name: List PWD
  shell: pwd
  register: pwd_output
  delegate_to: localhost

- name: Debug 
  debug:
    msg: "{{ item }}"
  with_items:
    - "{{ ls_inf.stdout }}"
    - "{{ ls_root_dir.stdout }}"
    - "{{ pwd_output.stdout }}"

- name: Get Latest git commit SHA
  shell: git rev-parse HEAD
  register: git_output
  delegate_to: localhost
  ignore_errors: yes

- name: Update Log File
  lineinfile:
    owner: root
    group: "{{ user_group }}"
    create: yes
    path: "{{ log_path }}/ansible.log"
    insertafter: EOF
    line: "{{ ansible_date_time.date }} {{ ansible_date_time.time }} {{ git_output.stdout }}"
  become: yes
  become_user: root
