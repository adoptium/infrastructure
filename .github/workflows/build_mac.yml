name: Ansible Playbook

on:
  pull_request:
    paths:
    - .github/workflows/build_mac.yml
    - ansible/playbooks/AdoptOpenJDK_Unix_Playbook/**
    branches:
    - master

permissions:
  contents: read

jobs:
  build-macos:
    name: macOS
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: [macos-13]
          - os: [macos-14]
      fail-fast: false
    steps:

    - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

    - name: Install Python
      run: brew install python@3.12 --overwrite

    - name: Configure dirmgr
      run: |
        mkdir -p ~/.gnupg/
        touch ~/.gnupg/dirmngr.conf
        echo "standard-resolver" >  ~/.gnupg/dirmngr.conf

    - name: Install Ansible
      run: brew install ansible

    - name: Run Ansible Playbook
      run: |
        echo "localhost ansible_user=runner ansible_connection=local" > ansible/hosts
        set -eux
        cd ansible
        sudo ansible-playbook -i hosts playbooks/AdoptOpenJDK_Unix_Playbook/main.yml --skip-tags="hosts_file,hostname,brew_upgrade,brew_cu,kernel_tuning,adoptopenjdk,jenkins,nagios,superuser,swap_file,crontab"

  build-macos15:
    name: macOS15
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: [macos-15]
      fail-fast: false
    steps:

    - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

    - name: Install Python
      run: brew install python@3.12 --overwrite

    - name: Configure dirmgr
      run: |
        mkdir -p ~/.gnupg/
        touch ~/.gnupg/dirmngr.conf
        echo "standard-resolver" >  ~/.gnupg/dirmngr.conf

    - name: Install Ansible
      run: brew install ansible

    - name: Run Ansible Playbook
      run: |
        echo "localhost ansible_user=runner ansible_connection=local" > ansible/hosts
        set -eux
        cd ansible
        sudo ansible-playbook -i hosts playbooks/AdoptOpenJDK_Unix_Playbook/main.yml --skip-tags="hosts_file,hostname,brew_upgrade,brew_cu,kernel_tuning,adoptopenjdk,jenkins,nagios,superuser,swap_file,crontab"

    - name: Debug
      run: |
        ls -la /usr/local/apache-ant-1.10.15/lib/ant-contrib.jar
        ls -la /usr/local/apache-ant-1.10.15/lib/

    - name: Run sanity openjdk test
      run: |
        cd ~ && mkdir jdk21
        wget -O jdk21.tar.gz -q "https://github.com/adoptium/temurin21-binaries/releases/download/jdk-21.0.8%2B9/OpenJDK21U-jdk_aarch64_mac_hotspot_21.0.8_9.tar.gz" && tar xvzf jdk21.tar.gz -C ./jdk21 --strip-components=1
        mkdir jdk21_testimage
        wget -O jdk21.testimage.tar.gz -q "https://github.com/adoptium/temurin21-binaries/releases/download/jdk-21.0.8%2B9/OpenJDK21U-testimage_aarch64_mac_hotspot_21.0.8_9.tar.gz" && tar xvzf jdk21.testimage.tar.gz -C ./jdk21_testimage --strip-components=1
        export TEST_JDK_HOME=$PWD/jdk21/Contents/Home
        export NATIVE_TEST_LIBS=$PWD/jdk21_testimage
        git clone https://github.com/adoptium/aqa-tests.git
        cd aqa-tests && ./get.sh
        export BUILD_LIST=openjdk
        cd TKG && make compile && make _sanity.openjdk
