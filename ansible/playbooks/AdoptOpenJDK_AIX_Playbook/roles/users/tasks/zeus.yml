#####################
# superuser account #
#####################
---
- name: Check for sudo installation
  stat:
    path: /etc/sudoers
  register: sudoers

- name: "Check for {{ username }} keyfile"
  stat:
    path: "{{ lookup('file', '{{ Zeus_User_SSHKey }}') }}"
  register: auth_key
  delegate_to: localhost
  ignore_errors: yes
  when: sudoers.stat.exists and sudoers.stat.isreg and Superuser_Account == "Enabled"

- name: "Customize {{ username }}"
  block:
    - name: Add key
      authorized_key:
        user: zeus
        state: present
        key: "{{ lookup('file', '{{ Zeus_User_SSHKey }}') }}"
      delegate_to: localhost
      ignore_errors: true

    - name: Grant zeus sudo powers
      lineinfile:
        dest: /etc/sudoers
        state: present
        regexp: '^zeus'
        line: 'zeus ALL=(ALL) NOPASSWD: ALL'
      ignore_errors: True
  when: auth_key is defined and auth_key.failed == False
