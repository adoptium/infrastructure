---
##########
# Alpine #
##########

############################
# Build Packages and tools #
############################
- name: Call Build Packages and Tools Task
  include_tasks: build_packages_and_tools.yml

- name: Checking for /usr/lib/jvm
  stat: path=/usr/lib/jvm
  register: usr_lib_jvm_exists
  tags: build_tools

- name: Creating /usr/lib/jvm if not found
  file:
    path: /usr/lib/jvm
    state: directory
    owner: root
    mode: 0755
  when:
    - not usr_lib_jvm_exists.stat.exists
  tags: build_tools

- name: Install JDK for x64
  when: ansible_architecture == "x86_64"
  block:
    - name: Check if zulu-7 is already installed in the target location
      stat: path=/usr/lib/jvm/zulu7
      register: zulu7_installed
      tags: build_tools

    - name: Install latest zulu-7 release if not already installed
      unarchive:
        src: https://cdn.azul.com/zulu/bin/zulu7.52.0.11-ca-jdk7.0.332-linux_x64.tar.gz
        dest: /usr/lib/jvm/
        remote_src: yes
      when:
        - not zulu7_installed.stat.exists
      tags: build_tools

    - name: Create symlink to point at zulu-7
      file:
        src: /usr/lib/jvm/zulu7.52.0.11-ca-jdk7.0.332-linux_x64
        dest: /usr/lib/jvm/zulu7
        state: link
      when:
        - not zulu7_installed.stat.exists
      tags: build_tools

    - name: Check if zulu-14 is already installed in the target location
      stat: path=/usr/lib/jvm/zulu14
      register: zulu14_installed
      tags: build_tools

    - name: Install latest zulu-14 release if not already installed
      unarchive:
        src: https://cdn.azul.com/zulu/bin/zulu14.29.23-ca-jdk14.0.2-linux_musl_x64.tar.gz
        dest: /usr/lib/jvm/
        remote_src: yes
      when:
        - not zulu14_installed.stat.exists
      tags: build_tools

    - name: Create symlink to point at zulu-14
      file:
        src: /usr/lib/jvm/zulu14.29.23-ca-jdk14.0.2-linux_musl_x64
        dest: /usr/lib/jvm/zulu14
        state: link
      when:
        - not zulu14_installed.stat.exists
      tags: build_tools

    - name: Check if zulu-15 is already installed in the target location
      stat: path=/usr/lib/jvm/zulu15
      register: zulu15_installed
      tags: build_tools

    - name: Install latest zulu-15 release if not already installed
      unarchive:
        src: https://cdn.azul.com/zulu/bin/zulu15.38.17-ca-jdk15.0.6-linux_musl_x64.tar.gz
        dest: /usr/lib/jvm/
        remote_src: yes
      when:
        - not zulu15_installed.stat.exists
      tags: build_tools

    - name: Create symlink to point at zulu-15
      file:
        src: /usr/lib/jvm/zulu15.38.17-ca-jdk15.0.6-linux_musl_x64
        dest: /usr/lib/jvm/zulu15
        state: link
      when:
        - not zulu15_installed.stat.exists
      tags: build_tools

- name: Install JDK for aarch64
  when: ansible_architecture == "aarch64"
  block:
    - name: Check if Temurin jdk8 is installed
      stat:
        path: /usr/lib/jvm/jdk8
      register: adoptopenjdk_installed

    - name: Install Temurin jdk8 nightly
      unarchive:
        src: https://ci.adoptopenjdk.net/job/build-scripts/job/jobs/job/jdk8u/job/jdk8u-alpine-linux-aarch64-temurin/lastSuccessfulBuild/artifact/workspace/target/OpenJDK8U-jdk_aarch64_alpine-linux_hotspot_2022-05-30-18-05.tar.gz
        dest: /usr/lib/jvm
        remote_src: yes
      retries: 3
      delay: 5
      register: adoptopenjdk_download
      until: adoptopenjdk_download is not failed
      when:
        - adoptopenjdk_installed.rc != 0

    - name: Get Temurin jdk8 full path name
      shell: set -o pipefail | ls -ld /usr/lib/jvm/jdk-8.* 2>/dev/null | awk '{print $9}'
      register: adoptopenjdk_dir
      when:
        - adoptopenjdk_installed.rc != 0

    - name: Create symlink to major version
      file:
        src: '{{ adoptopenjdk_dir.stdout }}'
        dest: /usr/lib/jvm/jdk8
        state: link
      when:
        - adoptopenjdk_installed.rc != 0

    - name: Check if Temurin jdk11 is installed
      stat:
        path: /usr/lib/jvm/jdk-11
      register: adoptopenjdk_installed

    - name: Install Temurin jdk-11 nightly
      unarchive:
        src: https://ci.adoptopenjdk.net/job/build-scripts/job/jobs/job/jdk11u/job/jdk11u-alpine-linux-aarch64-temurin/lastSuccessfulBuild/artifact/workspace/target/OpenJDK11U-jdk_aarch64_alpine-linux_hotspot_2022-05-26-18-05.tar.gz
        dest: /usr/lib/jvm
        remote_src: yes
      retries: 3
      delay: 5
      register: adoptopenjdk_download
      until: adoptopenjdk_download is not failed
      when:
        - adoptopenjdk_installed.rc != 0

    - name: Get Temurin jdk-11 full path name
      shell: set -o pipefail | ls -ld /usr/lib/jvm/jdk-11.* 2>/dev/null | awk '{print $9}'
      register: adoptopenjdk_dir
      when:
        - adoptopenjdk_installed.rc != 0

    - name: Create symlink to major version
      file:
        src: '{{ adoptopenjdk_dir.stdout }}'
        dest: /usr/lib/jvm/jdk-11
        state: link
      when:
        - adoptopenjdk_installed.rc != 0

    - name: Check if zulu-16 is already installed in the target location
      stat: path=/usr/lib/jvm/zulu16
      register: zulu16_installed

    - name: Install latest zulu-16 release if not already installed
      unarchive:
        src: https://cdn.azul.com/zulu/bin/zulu16.32.15-ca-jdk16.0.2-linux_musl_aarch64.tar.gz
        dest: /usr/lib/jvm/
        remote_src: yes
      when:
        - not zulu16_installed.stat.exists

    - name: Create symlink to point at zulu-16
      file:
        src: /usr/lib/jvm/zulu16.32.15-ca-jdk16.0.2-linux_musl_aarch64
        dest: /usr/lib/jvm/zulu16
        state: link
      when:
        - not zulu16_installed.stat.exists

    - name: Check if Temurin jdk17 is installed
      stat:
        path: /usr/lib/jvm/jdk-17
      register: adoptopenjdk_installed

    - name: Install Temurin jdk-17 nightly
      unarchive:
        src: https://ci.adoptopenjdk.net/job/build-scripts/job/jobs/job/jdk17u/job/jdk17u-alpine-linux-aarch64-temurin/lastSuccessfulBuild/artifact/workspace/target/OpenJDK17U-jdk_aarch64_alpine-linux_hotspot_2022-05-31-23-30.tar.gz
        dest: /usr/lib/jvm
        remote_src: yes
      retries: 3
      delay: 5
      register: adoptopenjdk_download
      until: adoptopenjdk_download is not failed
      when:
        - adoptopenjdk_installed.rc != 0

    - name: Get Temurin jdk-17 full path name
      shell: set -o pipefail | ls -ld /usr/lib/jvm/jdk-17.* 2>/dev/null | awk '{print $9}'
      register: adoptopenjdk_dir
      when:
        - adoptopenjdk_installed.rc != 0

    - name: Create symlink to major version
      file:
        src: '{{ adoptopenjdk_dir.stdout }}'
        dest: /usr/lib/jvm/jdk-11
        state: link
      when:
        - adoptopenjdk_installed.rc != 0

    - name: Check if zulu-18 is already installed in the target location
      stat: path=/usr/lib/jvm/zulu18
      register: zulu18_installed

    - name: Install latest zulu-18 release if not already installed
      unarchive:
        src: https://cdn.azul.com/zulu/bin/zulu18.28.13-ca-jdk18.0.0-linux_musl_aarch64.tar.gz
        dest: /usr/lib/jvm/
        remote_src: yes
      when:
        - not zulu18_installed.stat.exists

    - name: Create symlink to point at zulu-18
      file:
        src: /usr/lib/jvm/zulu18.28.13-ca-jdk18.0.0-linux_musl_aarch64
        dest: /usr/lib/jvm/zulu18
        state: link
      when:
        - not zulu18_installed.stat.exists
  tags: build_tools
