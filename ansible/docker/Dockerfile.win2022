FROM mcr.microsoft.com/windows/servercore:ltsc2022

# Specify this with --build-arg PW=SomePassword
ARG PW=T3mp=Passwd

# Download Cygwin Bootstrapper & Verify Its Checksum
RUN powershell -Command \
    "wget -UseBasicParsing https://cygwin.com/setup-x86_64.exe -OutFile setup-x86_64.exe; \
    $expectedChecksum = '46993d76d756bde18564f72a4ee07384cd82b447527ca406c8bfc034cb05c664'; \
    $fileChecksum = CertUtil -hashfile setup-x86_64.exe SHA256 | Select-String -Pattern '([A-Fa-f0-9]{64})' | ForEach-Object { $_.Matches[0].Groups[1].Value }; \
    if ($fileChecksum -ne $expectedChecksum) { \
        Write-Host 'Checksum verification failed!' -ForegroundColor Red; \
        Remove-Item setup-x86_64.exe; \
        exit 1; \
    } else { \
        Write-Host 'Checksum verification succeeded!' -ForegroundColor Green; \
    }"

# Set up cygwin with ansible as a bootstrap, and add to system default path
RUN setup-x86_64.exe --packages ansible --download --local-install --delete-orphans --site https://mirrors.kernel.org/sourceware/cygwin --local-package-dir c:\cygwin_packages --root C:\cygwin64 --wait --quiet-mode && \
    del setup-x86_64.exe && \
    setx PATH "c:\cygwin64\bin;%PATH%" && \
    mkdir c:\temp

# Download Ansible Config Script & Verify Its Checksum
RUN powershell -Command \
    "wget https://raw.githubusercontent.com/ansible/ansible/dd4c56e4d68664e4a50292aa19ea61b15c92287c/examples/scripts/ConfigureRemotingForAnsible.ps1 -OutFile ConfigureRemotingForAnsible.ps1; \
    $expectedChecksum = '201ad16584f79292044dc21c78c6688dce07f94d769f5e69631b46c3c13036fc'; \
    $fileChecksum = CertUtil -hashfile ConfigureRemotingForAnsible.ps1 SHA256 | Select-String -Pattern '([A-Fa-f0-9]{64})' | ForEach-Object { $_.Matches[0].Groups[1].Value }; \
    if ($fileChecksum -ne $expectedChecksum) { \
        Write-Host 'Checksum verification failed!' -ForegroundColor Red; \
        Remove-Item ConfigureRemotingForAnsible.ps1; \
        exit 1; \
    } else { \
        Write-Host 'Checksum verification succeeded!' -ForegroundColor Green; \
    }"

# Set up WinRM for the ansible connection
RUN PowerShell .\ConfigureRemotingForAnsible.ps1 -CertValidityDays 9999 & \
    PowerShell .\ConfigureRemotingForAnsible.ps1 -EnableCredSSP & \
    PowerShell .\ConfigureRemotingForAnsible.ps1 -ForceNewSSLCert & \
    PowerShell .\ConfigureRemotingForAnsible.ps1 -SkipNetworkProfileCheck

# Set up WinRM user, clone and run the playbook, then delete the user so it's not in any layer
ENV TERM=dumb

COPY . infrastructure

RUN net user ansible %PW% /ADD & net localgroup "Administrators" ansible /ADD & net localgroup "Remote Management Users" ansible /ADD && \
    sed -i -e 's/hosts: .*/hosts: localhost/' infrastructure/ansible/playbooks/AdoptOpenJDK_Windows_Playbook/main.yml && \
    echo localhost ansible_connection=winrm > infrastructure/ansible/hosts && \
    cd infrastructure\ansible && \
    C:\cygwin64\bin\python3.7m.exe /usr/bin/ansible-playbook -e git_sha=00000000 -e ansible_user=ansible -e ansible_password=%PW% -i hosts \
    --skip-tags=adoptopenjdk,reboot,Windows_Updates,NTP_TIME,MSVS_2013,MSVS_2017,MSVS_2019,NVidia_Cuda_Toolkit,clang_64bit,clang_32bit,nasm,Rust,IcedTea-Web playbooks/AdoptOpenJDK_Windows_Playbook/main.yml && \
    net user ansible /DELETE

ENTRYPOINT ["C:\\Program Files (x86)\\Microsoft Visual Studio\\2022\\BuildTools\\Common7\\Tools\\VsDevCmd.bat", "&&", "powershell.exe", "-NoLogo", "-ExecutionPolicy", "Bypass"]
USER ContainerUser
