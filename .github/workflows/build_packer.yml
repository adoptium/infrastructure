name: Packer

on:
  workflow_dispatch:
  push:
    paths:
    - .github/workflows/build_packer.yml
    - ansible/playbooks/AdoptOpenJDK_Unix_Playbook/**
    - ansible/packer/**
    branches:
    - master

permissions:
  contents: read

jobs:
  run-packer:
    name: Run Packer
    runs-on: ubuntu-latest
    steps:

    - uses: actions/checkout@93ea575cb5d8a053eaa0ac8fa3b40d7e05a33cc8 # v3.1.0

    - name: Install openconnect
      run: sudo apt-get install openconnect

    - name: Connect to Orka VPN using openconnect
      run: |
        echo ${{ secrets.ORKA_VPN_PASSWORD }} |
        sudo openconnect \
          ${{ secrets.ORKA_VPN }} \
          --protocol=anyconnect \
          --background \
          --user=${{ secrets.ORKA_VPN_USER }} \
          --passwd-on-stdin \
          --servercert pin-sha256:bRJt1DUgnbH6Mi2GjvLohOzVs0mmjkwb4Nyi62h+LZM=

    - name: Intialize Packer
      working-directory: ansible/packer
      run: packer init orka.pkr.hcl

    - name: Build Packer
      working-directory: ansible/packer
      run: packer build orka.pkr.hcl
      env:
        ORKA_TOKEN: ${{ secrets.ORKA_TOKEN }}
