---
#######################################
# Incredibuild - Configuration Tasks  #
#######################################

- name: Check if the IBXDashboard service exists
  win_shell: |
    if (Get-Service -Name 'IBXDashboard' -ErrorAction SilentlyContinue) {
      Write-Host "exists"
    }
  register: service_info
  changed_when: false

- name: Stop the IBX Dashboard service if it exists
  win_service:
    name: IBXDashboard
    state: stopped
  when: "'exists' in service_info.stdout"

- name: Check if incredibuild.conf file exists
  win_stat:
    path: 'C:\Program Files (x86)\IncrediBuild\Dashboard\Apache24\conf\incredibuild.conf'
  register: incredibuild_conf_file

- name: Replace APACHE_PORT in incredibuild.conf if file exists
  win_lineinfile:
    path: 'C:\Program Files (x86)\IncrediBuild\Dashboard\Apache24\conf\incredibuild.conf'
    regexp: '^define APACHE_PORT \d+$'
    line: 'define APACHE_PORT 31000'
    backup: yes
  when: incredibuild_conf_file.stat.exists

- name: Start the IBX Dashboard service if it exists
  win_service:
    name: IBXDashboard
    state: started
  when: "'exists' in service_info.stdout"
